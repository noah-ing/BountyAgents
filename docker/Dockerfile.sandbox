# =============================================================================
# Vulnerability Swarm Sandbox
#
# Secure environment for running exploit PoCs on forked blockchains.
# Contains: Foundry, Slither, Mythril, Python analysis tools
# =============================================================================

FROM ubuntu:22.04

# Prevent interactive prompts during installation
ENV DEBIAN_FRONTEND=noninteractive

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    git \
    build-essential \
    python3 \
    python3-pip \
    python3-venv \
    nodejs \
    npm \
    software-properties-common \
    libssl-dev \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

# Install Rust (required for Foundry and ibb)
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"

# Install Foundry (forge, cast, anvil)
RUN curl -L https://foundry.paradigm.xyz | bash && \
    /root/.foundry/bin/foundryup
ENV PATH="/root/.foundry/bin:${PATH}"

# Install ibb CLI (Immunefi CLI tool)
RUN cargo install ibb

# Install Python security tools
RUN pip3 install --upgrade pip && \
    pip3 install \
    slither-analyzer \
    mythril \
    solc-select \
    crytic-compile \
    web3 \
    eth-abi

# Install common Solidity versions
RUN solc-select install 0.8.19 0.8.20 0.8.21 0.8.22 0.8.23 0.8.24 0.8.25 && \
    solc-select use 0.8.25

# Install Node.js tools
RUN npm install -g \
    @openzeppelin/contracts \
    hardhat \
    ethers

# Create workspace directory
WORKDIR /workspace

# Create non-root user for security
RUN useradd -m -s /bin/bash hunter && \
    chown -R hunter:hunter /workspace

# Copy Foundry project template
COPY contracts/ /workspace/contracts/
RUN chown -R hunter:hunter /workspace/contracts

# Environment variables for blockchain connections
ENV ETH_RPC_URL=""
ENV ARBISCAN_API_KEY=""
ENV ETHERSCAN_API_KEY=""
ENV POLYGONSCAN_API_KEY=""

# Switch to non-root user
USER hunter

# Default command - start anvil with mainnet fork
CMD ["anvil", "--host", "0.0.0.0", "--port", "8545"]

# Expose anvil port
EXPOSE 8545

# =============================================================================
# Build:
#   docker build -t bounty-agents-sandbox -f docker/Dockerfile.sandbox .
#
# Run with mainnet fork:
#   docker run -it -p 8545:8545 \
#     -e ETH_RPC_URL="https://eth-mainnet.g.alchemy.com/v2/YOUR_KEY" \
#     bounty-agents-sandbox
#
# Run exploit test:
#   docker run -it --rm \
#     -v $(pwd)/exploits:/workspace/exploits \
#     -e ETH_RPC_URL="https://eth-mainnet.g.alchemy.com/v2/YOUR_KEY" \
#     bounty-agents-sandbox \
#     forge test --fork-url $ETH_RPC_URL -vvv
# =============================================================================
